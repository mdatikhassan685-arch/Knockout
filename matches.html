<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Matches</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body class="bg-gray-900 text-white pb-20 select-none">

    <header class="p-4 bg-gray-800 shadow-md flex items-center sticky top-0 z-50">
        <a href="/home" class="mr-4 text-gray-400 active:scale-90 transition"><i class="fa-solid fa-arrow-left text-xl"></i></a>
        <div class="text-xl font-bold truncate w-40" id="cat_title">Matches</div>
        <div class="ml-auto bg-gray-700 px-3 py-1 rounded-full text-xs font-bold text-yellow-400 border border-gray-600">
            ‡ß≥ <span id="header_bal">...</span>
        </div>
    </header>

    <div id="match_list" class="p-4 space-y-4">
        <div class="text-center mt-10 text-gray-500 animate-pulse">Loading...</div>
    </div>

    <!-- JOIN MODAL -->
    <div id="joinModal" class="fixed inset-0 bg-black/95 hidden items-center justify-center z-[60] p-4 backdrop-blur-sm">
        <div class="bg-gray-800 p-5 rounded-2xl w-full max-w-sm border border-gray-700 shadow-2xl relative">
            <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-500 hover:text-white"><i class="fa-solid fa-times text-lg"></i></button>
            <h3 class="text-xl font-bold mb-1 text-white">Join <span id="modal_match_type" class="text-blue-400"></span></h3>
            <p class="text-xs text-gray-400 mb-4 pb-2 border-b border-gray-700">Entry: <span class="text-yellow-400 font-bold" id="modal_fee"></span></p>
            <input type="hidden" id="join_match_id">
            
            <div class="space-y-3">
                <input type="text" id="game_name" class="w-full bg-gray-900 border border-gray-600 p-3 rounded text-white text-sm outline-none" placeholder="Exact Game Name">
                <div class="flex gap-2">
                    <input type="text" id="game_uid" class="w-full bg-gray-900 border border-gray-600 p-3 rounded text-white text-sm outline-none" placeholder="UID (Optional)">
                    <input type="number" id="game_level" class="w-full bg-gray-900 border border-gray-600 p-3 rounded text-white text-sm outline-none text-center font-bold" placeholder="Lvl 40+">
                </div>
            </div>
            
            <button onclick="confirmJoin()" id="join_btn" class="w-full mt-4 bg-blue-600 py-3 rounded-xl font-bold hover:bg-blue-700 transition">Confirm & Join</button>
        </div>
    </div>

    <script>
        const user = JSON.parse(localStorage.getItem('user'));
        if (!user) window.location.href = '/';
        const urlParams = new URLSearchParams(window.location.search);
        const catId = urlParams.get('cat_id');
        const catName = urlParams.get('name');
        if(catName) document.getElementById('cat_title').innerText = catName;

        async function fetchBalance() {
            try {
                const res = await fetch('/api/user', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ type: 'wallet_info', user_id: user.id }) });
                const data = await res.json();
                if(data.balance !== undefined) document.getElementById('header_bal').innerText = parseFloat(data.balance).toFixed(2);
            } catch(e) {}
        }
        fetchBalance(); 

        async function loadMatches() {
            if(!catId) return;
            try {
                const res = await fetch('/api/tournament', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ type: 'get_daily_matches', category_id: catId, user_id: user.id }) });
                const matches = await res.json();
                const container = document.getElementById('match_list');

                if(matches.length > 0) {
                    container.innerHTML = matches.map(m => {
                        const totalSpots = 48; const joined = m.joined_count || 0;
                        const filled = (joined / totalSpots) * 100;
                        const status = m.status || 'upcoming';
                        const isJoined = m.is_joined > 0;
                        
                        const feeText = parseFloat(m.entry_fee) === 0 ? "FREE" : "‡ß≥" + m.entry_fee;

                        // üî• TIME FIX: Server time convert to Locale String Properly
                        const matchDate = new Date(m.match_time);
                        // ‡¶Ø‡¶¶‡¶ø ‡¶ü‡¶æ‡¶á‡¶Æ‡¶ú‡ßã‡¶® ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶ï‡¶∞‡ßá, ‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø UTC ‡¶•‡ßá‡¶ï‡ßá ‡¶≤‡ßã‡¶ï‡¶æ‡¶≤ ‡¶ï‡¶®‡¶≠‡¶æ‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶õ‡¶ø ‡¶®‡¶æ, ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü ‡¶ï‡¶∞‡¶õ‡¶ø‡•§
                        // ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡¶π‡¶ú ‡¶´‡¶ø‡¶ï‡ßç‡¶∏: ‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶∏‡¶Æ‡ßü‡¶ü‡¶æ ‡¶∏‡ßÅ‡¶®‡ßç‡¶¶‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßã
                        const timeStr = matchDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true });
                        const dateStr = matchDate.toLocaleDateString([], { day: 'numeric', month: 'short' });
                        const finalDate = `${dateStr}, ${timeStr}`;

                        let btn;
                        if(isJoined) btn=`<button class="w-full py-3 rounded-xl font-bold bg-green-600 text-white">Joined ‚úÖ</button>`;
                        else if(status === 'open') btn=`<button onclick="openJoin(${m.id}, '${m.match_type}', ${m.entry_fee})" class="w-full py-3 rounded-xl font-bold bg-blue-600 text-white shadow-lg">JOIN</button>`;
                        else btn=`<button disabled class="w-full py-3 rounded-xl font-bold bg-gray-700 text-gray-500">LOCKED</button>`;

                        return `
                        <div class="bg-gray-800 rounded-2xl overflow-hidden border border-gray-700 shadow-lg relative group">
                            <div class="bg-gray-750 p-3 border-b border-gray-700 flex justify-between items-center">
                                <h3 class="font-bold text-white text-md">#${m.id} ${m.title}</h3>
                                <div class="text-[10px] font-bold text-gray-300 bg-gray-900 px-2 py-1 rounded border border-gray-600">${finalDate}</div>
                            </div>
                            <div class="p-4">
                                <div class="grid grid-cols-3 gap-2 text-center mb-4">
                                    <div class="bg-gray-900 p-2 rounded border border-gray-700"><p class="text-[9px] text-gray-400">Prize</p><p class="text-green-400 text-sm font-bold">‡ß≥${m.prize_pool}</p></div>
                                    <div class="bg-gray-900 p-2 rounded border border-gray-700"><p class="text-[9px] text-gray-400">Type</p><p class="text-blue-400 text-sm font-bold uppercase">${m.match_type}</p></div>
                                    <div class="bg-gray-900 p-2 rounded border border-gray-700"><p class="text-[9px] text-gray-400">Entry</p><p class="text-yellow-400 text-sm font-bold">${feeText}</p></div>
                                </div>
                                <div class="mb-4 w-full bg-gray-700 h-1.5 rounded-full overflow-hidden"><div class="bg-blue-500 h-full" style="width: ${filled}%"></div></div>
                                ${btn}
                            </div>
                        </div>`;
                    }).join('');
                } else { container.innerHTML = `<div class="text-center mt-20 text-gray-500">No matches found.</div>`; }
            } catch(e) {}
        }

        function openJoin(id, type, fee) {
            document.getElementById('join_match_id').value = id;
            document.getElementById('modal_match_type').innerText = type;
            document.getElementById('modal_fee').innerText = fee === 0 ? "FREE" : "‡ß≥" + fee;
            document.getElementById('joinModal').style.display = 'flex';
        }

        function closeModal() { document.getElementById('joinModal').style.display = 'none'; }

        async function confirmJoin() {
            const id = document.getElementById('join_match_id').value;
            const name = document.getElementById('game_name').value;
            const uid = document.getElementById('game_uid').value;
            const lvl = document.getElementById('game_level').value;

            if(!name || !lvl) return alert("Fill Name & Level");
            if(parseInt(lvl) < 40) return alert("Level must be 40+");

            const btn = document.getElementById('join_btn'); btn.disabled=true; btn.innerText="Processing...";

            try {
                const res = await fetch('/api/tournament', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    // Ensure match_id is sent as INT/NUMBER, not string
                    body: JSON.stringify({ 
                        type: 'join_daily_match', 
                        user_id: user.id, 
                        match_id: parseInt(id), // üî• FIX: Integer parsing ensures DB match
                        game_name: name, 
                        game_uid: uid 
                    })
                });
                const d = await res.json();
                if(d.success) { alert("Joined!"); closeModal(); loadMatches(); fetchBalance(); }
                else { alert(d.error); btn.disabled=false; btn.innerText="Try Again"; }
            } catch(e) { alert("Error"); btn.disabled=false; }
        }
        
        loadMatches();
    </script>
</body>
</html>
