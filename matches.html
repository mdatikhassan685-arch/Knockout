<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Matches</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>body { font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; } .custom-scroll::-webkit-scrollbar { width: 4px; }</style>
</head>
<body class="bg-gray-900 text-white pb-20 select-none">

    <header class="p-4 bg-gray-800 shadow-md flex items-center sticky top-0 z-50">
        <a href="/home" class="mr-4 text-gray-400 active:scale-90"><i class="fa-solid fa-arrow-left text-xl"></i></a>
        <div class="text-xl font-bold truncate w-40" id="cat_title">Matches</div>
        <div class="ml-auto bg-gray-700 px-3 py-1 rounded-full text-xs font-bold text-yellow-400 border border-gray-600">৳ <span id="header_bal">...</span></div>
    </header>

    <div id="match_list" class="p-4 space-y-4">
        <div class="text-center mt-10 text-gray-500 animate-pulse">Loading Matches...</div>
    </div>

    <!-- JOIN MODAL -->
    <div id="joinModal" class="fixed inset-0 bg-black/95 hidden items-center justify-center z-[60] p-4 backdrop-blur-sm"></div>

    <!-- PLAYERS MODAL -->
    <div id="playersListModal" class="fixed inset-0 bg-black/90 hidden items-center justify-center z-[70] p-4 backdrop-blur-sm">
        <div class="bg-gray-800 p-5 rounded-2xl w-full max-w-sm border border-gray-600 h-[70vh] flex flex-col shadow-2xl relative">
            <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-3">
                <h3 class="font-bold text-lg text-blue-400">Match Participants</h3>
                <button onclick="document.getElementById('playersListModal').style.display='none'" class="text-gray-400"><i class="fa-solid fa-times"></i></button>
            </div>
            <div id="joined_players_list" class="overflow-y-auto flex-1 space-y-2 pr-1 custom-scroll text-sm"></div>
        </div>
    </div>
    
    <!-- ROOM MODAL -->
    <div id="roomDetailsModal" class="fixed inset-0 bg-black/90 hidden items-center justify-center z-[60] p-4 backdrop-blur-sm">
        <div class="bg-gray-800 p-6 rounded-2xl w-full max-w-sm border border-gray-700 text-center relative">
            <button onclick="document.getElementById('roomDetailsModal').style.display='none'" class="absolute top-4 right-4 text-gray-500"><i class="fa-solid fa-times"></i></button>
            <h3 class="text-lg font-bold mb-4">Room Info</h3>
            <p class="text-[10px] uppercase text-gray-500 mb-1">ID & Pass</p>
            <div class="bg-black/30 p-3 rounded text-xl font-bold tracking-widest text-yellow-400 mb-2 select-all" id="room_text"></div>
            <p class="text-xs text-gray-500">Only visible to joined players.</p>
        </div>
    </div>

    
    <script>
        const user = JSON.parse(localStorage.getItem('user'));
        if (!user) window.location.href = '/';

        const urlParams = new URLSearchParams(window.location.search);
        const catId = urlParams.get('cat_id');
        const catName = urlParams.get('name');
        if(catName) document.getElementById('cat_title').innerText = catName;

        // ... Balance & Load Logic ... (সেম থাকবে, শুধু openJoin পরিবর্তন করছি)
        // বাকি loadMatches এবং viewResult, viewRoom ফাংশন আগের মতোই থাকবে
        // আমি এখানে শুধু আপডেটেড অংশগুলো দিচ্ছি:

        // 1. UPDATED JOIN MODAL (টিম মেম্বারদের ইনপুট বক্সসহ)
        function openJoin(id, type, fee) {
            document.getElementById('join_match_id').value = id;
            const feeTxt = fee === 0 ? "FREE" : "৳" + fee;
            let teamFields = '';

            let count = (type === 'Duo') ? 2 : (type === 'Squad') ? 4 : 1;
            
            // টিমের জন্য ইনপুট লুপ
            if (count > 1) {
                // Team Name Input
                teamFields += `
                <div class="mb-2 bg-gray-900 p-2 rounded border border-blue-500/30">
                    <label class="text-[10px] text-blue-400 font-bold uppercase mb-1 block">Team Name</label>
                    <input type="text" id="team_name" class="w-full bg-transparent text-white text-sm outline-none font-bold" placeholder="Enter Team Name">
                </div>`;
            }

            // Player Inputs Loop
            for(let i = 1; i <= count; i++) {
                let label = count > 1 ? `Player ${i} ${i===1?'(You/Leader)':''}` : `Your Details`;
                
                teamFields += `
                <div class="bg-gray-800 p-2 mb-2 rounded border border-gray-600">
                    <p class="text-[10px] text-gray-400 font-bold uppercase mb-1">${label}</p>
                    <div class="grid grid-cols-2 gap-2 mb-1">
                        <input id="name_${i}" placeholder="In-Game Name" class="w-full bg-gray-900 border border-gray-600 p-2 rounded text-white text-xs outline-none">
                        <input id="uid_${i}" type="number" placeholder="UID" class="w-full bg-gray-900 border border-gray-600 p-2 rounded text-white text-xs outline-none">
                    </div>
                    <input id="lvl_${i}" type="number" placeholder="Level (Min 40)" class="w-full bg-gray-900 border border-gray-600 p-2 rounded text-white text-xs outline-none">
                </div>`;
            }

            document.getElementById('joinModal').innerHTML = `
                <div class="bg-gray-800 p-5 rounded-2xl w-full max-w-sm border border-gray-700 shadow-2xl relative max-h-[85vh] overflow-hidden flex flex-col">
                    <div class="flex justify-between items-center mb-2 pb-2 border-b border-gray-700">
                        <h3 class="text-xl font-bold text-white">Join <span class="text-blue-400">${type}</span></h3>
                        <button onclick="document.getElementById('joinModal').style.display='none'" class="text-gray-500 hover:text-white"><i class="fa-solid fa-times text-lg"></i></button>
                    </div>
                    <p class="text-xs text-yellow-400 font-bold mb-2">Total Fee: ${feeTxt}</p>
                    
                    <div class="overflow-y-auto pr-1 flex-1 custom-scroll mb-2">
                        ${teamFields}
                    </div>
                    
                    <button onclick="confirmJoin('${id}', '${type}')" id="join_btn" class="w-full bg-blue-600 py-3 rounded-xl font-bold text-white shadow-lg transition hover:bg-blue-500">Confirm Registration</button>
                </div>`;
            document.getElementById('joinModal').style.display = 'flex';
        }

        // 2. UPDATED CONFIRM LOGIC (সব মেম্বারের ডাটা প্রসেস করা)
        async function confirmJoin(id, type) {
            let count = (type === 'Duo') ? 2 : (type === 'Squad') ? 4 : 1;
            let teamName = '';

            if (count > 1) {
                teamName = document.getElementById('team_name').value;
                if (!teamName) return alert("Enter Team Name!");
            }

            let players = [];
            
            for(let i=1; i<=count; i++) {
                let name = document.getElementById(`name_${i}`).value;
                let uid = document.getElementById(`uid_${i}`).value;
                let lvl = document.getElementById(`lvl_${i}`).value;

                if(!name || !uid || !lvl) return alert(`Please fill details for Player ${i}`);
                if(parseInt(lvl) < 40) return alert(`Player ${i} Level must be 40+`);
                
                players.push({ name, uid, level: lvl });
            }

            const btn = document.getElementById('join_btn'); 
            btn.disabled=true; btn.innerText="Registering...";

            try {
                const res = await fetch('/api/tournament', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    // players array পাঠাচ্ছি ব্যাকএন্ডে
                    body: JSON.stringify({ 
                        type: 'join_daily_match', 
                        user_id: user.id, 
                        match_id: id, 
                        team_name: teamName, 
                        players: players 
                    })
                });
                const d = await res.json();
                if(d.success) { 
                    alert("Team Registered Successfully!"); 
                    document.getElementById('joinModal').style.display='none'; 
                    loadMatches(); fetchBalance(); 
                }
                else { alert(d.error); btn.disabled=false; }
            } catch(e) { alert("Error"); btn.disabled=false; }
        }

        // বাকি লোডিং ও ডিসপ্লে কোড যেমন ছিল তেমনই থাকবে...
        // viewPlayers, loadMatches এগুলো চেঞ্জ করতে হবে না, শুধু ওগুলোর HTML আগেরটাতেই কাজ করবে।
        
        loadMatches();
    </script>
</body>
</html>
