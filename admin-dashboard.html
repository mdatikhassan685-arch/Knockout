<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body class="bg-gray-900 text-white font-sans pb-20 select-none">

    <header class="p-4 bg-gray-800 shadow-md flex justify-between items-center sticky top-0 z-50 border-b border-gray-700">
        <div class="text-xl font-bold text-red-500 italic uppercase">Knockout Admin</div>
        <button onclick="logout()" class="bg-red-600 px-4 py-1.5 rounded-lg text-xs font-black uppercase hover:bg-red-700 transition active:scale-95">Logout</button>
    </header>

    <div class="p-4 grid grid-cols-2 gap-4">
        <div class="bg-gray-800 p-4 rounded-xl border-l-4 border-blue-500 shadow-lg">
            <p class="text-gray-400 text-[10px] uppercase font-bold">Total Users</p>
            <h2 class="text-2xl font-black mt-1" id="total_users">0</h2>
        </div>
        <div class="bg-gray-800 p-4 rounded-xl border-l-4 border-green-500 shadow-lg">
            <p class="text-gray-400 text-[10px] uppercase font-bold">Total Deposits</p>
            <h2 class="text-2xl font-black mt-1" id="total_deposit">৳0</h2>
        </div>
        <div class="bg-gray-800 p-4 rounded-xl border-l-4 border-yellow-500 shadow-lg">
            <p class="text-gray-400 text-[10px] uppercase font-bold">Total Matches</p>
            <h2 class="text-2xl font-black mt-1" id="total_matches">0</h2>
        </div>
        <div class="bg-gray-800 p-4 rounded-xl border-l-4 border-red-500 shadow-lg">
            <p class="text-gray-400 text-[10px] uppercase font-bold">Withdrawals</p>
            <h2 class="text-2xl font-black mt-1" id="total_withdraw">৳0</h2>
        </div>
    </div>

    <div class="px-4 grid grid-cols-2 gap-3 mb-6">
        <a href="/admin-categories.html" class="bg-indigo-600 p-3 rounded-xl text-center font-bold text-sm shadow-lg active:scale-95 transition"><i class="fa-solid fa-list-check mr-2"></i>Categories</a>
        <a href="/admin-matches.html" class="bg-purple-600 p-3 rounded-xl text-center font-bold text-sm shadow-lg active:scale-95 transition"><i class="fa-solid fa-gamepad mr-2"></i>Matches</a>
    </div>

    <div class="p-4 space-y-6">
        <div class="bg-gray-800 rounded-xl overflow-hidden border border-gray-700 shadow-2xl">
            <div class="p-4 bg-gray-700 border-b border-gray-600">
                <h3 class="font-bold text-xs uppercase tracking-widest text-green-400"><i class="fa-solid fa-wallet mr-2"></i>Pending Deposits</h3>
            </div>
            <div class="overflow-x-auto" id="deposit_list">
                <p class="p-10 text-center text-gray-500 text-xs italic">Checking for deposits...</p>
            </div>
        </div>

        <div class="bg-gray-800 rounded-xl overflow-hidden border border-gray-700 shadow-2xl">
            <div class="p-4 bg-gray-700 border-b border-gray-600">
                <h3 class="font-bold text-xs uppercase tracking-widest text-red-400"><i class="fa-solid fa-money-bill-transfer mr-2"></i>Pending Withdrawals</h3>
            </div>
            <div class="overflow-x-auto" id="withdraw_list">
                <p class="p-10 text-center text-gray-500 text-xs italic">Checking for withdrawals...</p>
            </div>
        </div>
    </div>

    <script>
        // ১. স্ট্যাটাস লোড করা
        async function loadStats() {
            try {
                const res = await fetch('/api/admin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'get_stats' })
                });
                const data = await res.json();
                document.getElementById('total_users').innerText = data.total_users || 0;
                document.getElementById('total_deposit').innerText = '৳' + (data.total_deposit || 0);
                document.getElementById('total_matches').innerText = data.total_matches || 0;
                document.getElementById('total_withdraw').innerText = '৳' + (data.total_withdraw || 0);
            } catch (e) { console.error(e); }
        }

        // ২. রিকোয়েস্ট লিস্ট লোড করা
        async function loadRequests() {
            try {
                const res = await fetch('/api/admin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'get_pending_requests' })
                });
                const { deposits, withdrawals } = await res.json();

                // Deposit রেন্ডার
                const dList = document.getElementById('deposit_list');
                if(!deposits || deposits.length === 0) {
                    dList.innerHTML = '<p class="p-8 text-center text-gray-500 text-[10px]">No pending deposit requests.</p>';
                } else {
                    dList.innerHTML = `<table class="w-full text-left text-[11px]"><thead class="bg-black/30 text-gray-400"><tr><th class="p-3">Info</th><th class="p-3">Amount</th><th class="p-3 text-right">Actions</th></tr></thead><tbody class="divide-y divide-gray-700">
                        ${deposits.map(d => `<tr>
                            <td class="p-3">UID: ${d.user_id}<br><span class="text-blue-400 font-mono">${d.details}</span></td>
                            <td class="p-3 font-black text-green-400">৳${d.amount}</td>
                            <td class="p-3 text-right space-x-2">
                                <button onclick="processRequest('deposit', ${d.id}, 'success')" class="bg-green-600/20 text-green-500 p-2 rounded-lg hover:bg-green-600 hover:text-white"><i class="fa-solid fa-check"></i></button>
                                <button onclick="processRequest('deposit', ${d.id}, 'rejected')" class="bg-red-600/20 text-red-500 p-2 rounded-lg hover:bg-red-600 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
                            </td>
                        </tr>`).join('')}</tbody></table>`;
                }

                // Withdraw রেন্ডার
                const wList = document.getElementById('withdraw_list');
                if(!withdrawals || withdrawals.length === 0) {
                    wList.innerHTML = '<p class="p-8 text-center text-gray-500 text-[10px]">No pending withdrawal requests.</p>';
                } else {
                    wList.innerHTML = `<table class="w-full text-left text-[11px]"><thead class="bg-black/30 text-gray-400"><tr><th class="p-3">Method/Num</th><th class="p-3">Amount</th><th class="p-3 text-right">Actions</th></tr></thead><tbody class="divide-y divide-gray-700">
                        ${withdrawals.map(w => `<tr>
                            <td class="p-3 font-medium uppercase text-blue-300">${w.method}: ${w.account_number}<br><span class="text-gray-500 text-[9px]">User ID: ${w.user_id}</span></td>
                            <td class="p-3 font-black text-red-400">৳${w.amount}</td>
                            <td class="p-3 text-right space-x-2">
                                <button onclick="processRequest('withdraw', ${w.id}, 'success')" class="bg-green-600/20 text-green-500 p-2 rounded-lg hover:bg-green-600 hover:text-white"><i class="fa-solid fa-check"></i></button>
                                <button onclick="processRequest('withdraw', ${w.id}, 'rejected')" class="bg-red-600/20 text-red-500 p-2 rounded-lg hover:bg-red-600 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
                            </td>
                        </tr>`).join('')}</tbody></table>`;
                }
            } catch (e) { console.error(e); }
        }

        // ৩. রিকোয়েস্ট এক্সেপ্ট/রিজেক্ট প্রসেস
        async function processRequest(cat, id, status) {
            if(!confirm(`Confirm ${status} this ${cat}?`)) return;
            try {
                const res = await fetch('/api/admin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'update_request_status', category: cat, id, status })
                });
                const result = await res.json();
                if(result.success) {
                    alert("Operation Successful!");
                    loadStats();
                    loadRequests();
                } else {
                    alert("Error: " + result.error);
                }
            } catch (e) { alert("Network Error"); }
        }

        function logout() {
            localStorage.clear();
            window.location.href = '/index.html';
        }

        // শুরুতে লোড
        loadStats();
        loadRequests();
    </script>
</body>
</html>
