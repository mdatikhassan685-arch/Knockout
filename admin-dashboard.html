<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        .glass-modal { background: rgba(17, 24, 39, 0.95); backdrop-filter: blur(10px); }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans select-none">

    <header class="p-4 bg-gray-800 shadow-md flex justify-between items-center sticky top-0 z-50 border-b border-gray-700">
        <div class="text-xl font-bold text-red-500 italic uppercase italic">Knockout Admin</div>
        <button onclick="logout()" class="bg-red-600 px-4 py-1.5 rounded-lg text-xs font-black uppercase">Logout</button>
    </header>

    <div class="p-4 grid grid-cols-2 gap-4">
        <div class="bg-gray-800 p-4 rounded-xl border-l-4 border-blue-500 shadow-lg">
            <p class="text-gray-400 text-[10px] uppercase font-bold">Total Users</p>
            <h2 class="text-2xl font-black mt-1" id="total_users">0</h2>
        </div>

        <div class="bg-gray-800 p-4 rounded-xl border-l-4 border-yellow-500 shadow-lg">
            <p class="text-gray-400 text-[10px] uppercase font-bold">Total Matches</p>
            <h2 class="text-2xl font-black mt-1" id="total_matches">0</h2>
        </div>

        <div onclick="openManager('deposit')" class="bg-gray-800 p-4 rounded-xl border-l-4 border-green-500 shadow-lg active:scale-95 transition cursor-pointer relative overflow-hidden">
            <p class="text-gray-400 text-[10px] uppercase font-bold">Deposits</p>
            <h2 class="text-2xl font-black mt-1 text-green-400" id="total_deposit">৳0</h2>
            <div class="text-[9px] mt-2 text-green-500 font-bold uppercase underline">Manage Requests →</div>
        </div>

        <div onclick="openManager('withdraw')" class="bg-gray-800 p-4 rounded-xl border-l-4 border-red-500 shadow-lg active:scale-95 transition cursor-pointer relative overflow-hidden">
            <p class="text-gray-400 text-[10px] uppercase font-bold">Withdrawals</p>
            <h2 class="text-2xl font-black mt-1 text-red-400" id="total_withdraw">৳0</h2>
            <div class="text-[9px] mt-2 text-red-500 font-bold uppercase underline">Manage Requests →</div>
        </div>
    </div>

    <div class="px-4 grid grid-cols-2 gap-3 mb-6">
        <a href="/admin-categories.html" class="bg-indigo-600 p-3 rounded-xl text-center font-bold text-sm shadow-lg"><i class="fa-solid fa-list-check mr-2"></i>Categories</a>
        <a href="/admin-matches.html" class="bg-purple-600 p-3 rounded-xl text-center font-bold text-sm shadow-lg"><i class="fa-solid fa-gamepad mr-2"></i>Matches</a>
    </div>

    <div id="managerModal" class="fixed inset-0 z-[100] glass-modal hidden flex flex-col">
        <div class="p-4 bg-gray-800 flex justify-between items-center border-b border-gray-700">
            <h3 id="modalTitle" class="font-bold uppercase tracking-widest text-sm">Manager</h3>
            <button onclick="closeManager()" class="text-gray-400 p-2"><i class="fa-solid fa-times text-xl"></i></button>
        </div>
        <div class="flex-1 overflow-y-auto custom-scroll" id="modalContent">
            </div>
    </div>

    <script>
        // ১. স্ট্যাটাস লোড করা
        async function loadStats() {
            const res = await fetch('/api/admin', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: 'get_stats' })
            });
            const data = await res.json();
            document.getElementById('total_users').innerText = data.total_users || 0;
            document.getElementById('total_deposit').innerText = '৳' + (data.total_deposit || 0);
            document.getElementById('total_matches').innerText = data.total_matches || 0;
            document.getElementById('total_withdraw').innerText = '৳' + (data.total_withdraw || 0);
        }

        // ২. ম্যানেজার ওপেন করা
        async function openManager(mode) {
            const modal = document.getElementById('managerModal');
            const content = document.getElementById('modalContent');
            const title = document.getElementById('modalTitle');
            
            modal.classList.remove('hidden');
            content.innerHTML = '<p class="p-10 text-center animate-pulse">Loading Requests...</p>';
            
            if(mode === 'deposit') title.innerText = "Deposit Requests";
            else title.innerText = "Withdrawal Requests";

            const res = await fetch('/api/admin', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: 'get_pending_requests' })
            });
            const data = await res.json();

            if(mode === 'deposit') renderDeposits(data.deposits);
            else renderWithdrawals(data.withdrawals);
        }

        function renderDeposits(list) {
            const box = document.getElementById('modalContent');
            if(!list || list.length === 0) {
                box.innerHTML = '<p class="p-20 text-center text-gray-500 italic">No pending deposits.</p>';
                return;
            }
            box.innerHTML = list.map(d => `
                <div class="p-4 border-b border-gray-800 flex justify-between items-center bg-gray-900/50 mb-1">
                    <div>
                        <p class="text-[10px] text-blue-400 font-mono">ID: ${d.user_id}</p>
                        <p class="font-bold text-sm text-white">${d.details}</p>
                        <p class="text-lg font-black text-green-400 mt-1">৳${d.amount}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="updateReq('deposit', ${d.id}, 'success')" class="bg-green-600 p-3 rounded-lg"><i class="fa-solid fa-check"></i></button>
                        <button onclick="updateReq('deposit', ${d.id}, 'rejected')" class="bg-red-600 p-3 rounded-lg"><i class="fa-solid fa-x"></i></button>
                    </div>
                </div>
            `).join('');
        }

        function renderWithdrawals(list) {
            const box = document.getElementById('modalContent');
            if(!list || list.length === 0) {
                box.innerHTML = '<p class="p-20 text-center text-gray-500 italic">No pending withdrawals.</p>';
                return;
            }
            box.innerHTML = list.map(w => `
                <div class="p-4 border-b border-gray-800 flex justify-between items-center bg-gray-900/50 mb-1">
                    <div>
                        <p class="text-[10px] text-red-400 font-bold uppercase">${w.method}</p>
                        <p class="font-bold text-sm text-white">${w.account_number}</p>
                        <p class="text-lg font-black text-red-400 mt-1">৳${w.amount}</p>
                        <p class="text-[9px] text-gray-500">User UID: ${w.user_id}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="updateReq('withdraw', ${w.id}, 'success')" class="bg-green-600 p-3 rounded-lg"><i class="fa-solid fa-check"></i></button>
                        <button onclick="updateReq('withdraw', ${w.id}, 'rejected')" class="bg-red-600 p-3 rounded-lg"><i class="fa-solid fa-x"></i></button>
                    </div>
                </div>
            `).join('');
        }

        async function updateReq(cat, id, status) {
            if(!confirm("Confirm action?")) return;
            const res = await fetch('/api/admin', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: 'update_request_status', category: cat, id, status })
            });
            const d = await res.json();
            if(d.success) {
                alert("Updated!");
                closeManager();
                loadStats();
            } else alert("Error: " + d.error);
        }

        function closeManager() { document.getElementById('managerModal').classList.add('hidden'); }
        function logout() { localStorage.clear(); window.location.href = '/index.html'; }
        loadStats();
    </script>
</body>
</html>
