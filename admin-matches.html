<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Match Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>.custom-scroll::-webkit-scrollbar { width: 4px; background: #374151; } .custom-scroll::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 4px; }</style>
</head>
<body class="bg-gray-900 text-white pb-24 select-none">

    <!-- Header -->
    <header class="p-4 bg-gray-800 shadow-md flex items-center sticky top-0 z-50 border-b border-gray-700">
        <a href="/admin-dashboard.html" class="mr-4 text-gray-400 active:scale-90"><i class="fa-solid fa-arrow-left text-xl"></i></a>
        <div><h1 class="font-bold text-lg leading-tight truncate w-64">Manage Matches</h1><p class="text-[10px] text-gray-400">Match Operations</p></div>
    </header>

    <!-- Match List Container -->
    <div class="px-4 mt-4">
        <h3 class="font-bold text-lg mb-3 border-l-4 border-blue-500 pl-2">Active Matches</h3>
        <div id="match_list" class="space-y-4 pb-10"><p class="text-center text-gray-500 mt-10 animate-pulse">Loading matches...</p></div>
    </div>

    <!-- MODAL 1: UPDATE RESULTS (STATS ONLY) -->
    <div id="resultModal" class="fixed inset-0 bg-black/90 hidden items-center justify-center z-[80] p-4 backdrop-blur-sm">
        <div class="bg-gray-800 p-5 rounded-2xl w-full max-w-sm h-[85vh] flex flex-col relative shadow-2xl border border-gray-700 animate-zoom">
            <div class="flex justify-between items-center mb-3 pb-2 border-b border-gray-700">
                <div><h3 class="font-bold text-lg text-blue-400">Update Stats</h3><p class="text-[10px] text-gray-400">Set Kills & Rank</p></div>
                <button onclick="document.getElementById('resultModal').style.display='none'" class="text-gray-400 text-2xl hover:text-white">&times;</button>
            </div>
            <input type="hidden" id="stat_match_id"><input type="hidden" id="stat_is_solo">
            
            <div class="flex justify-between text-[9px] font-bold text-gray-500 uppercase px-2 mb-1">
                <span class="w-1/2">Name</span><span class="w-1/4 text-center">Rank #</span><span class="w-1/4 text-center">Kills</span>
            </div>
            <div id="stat_list" class="flex-1 overflow-y-auto pr-1 custom-scroll text-sm space-y-2">Loading...</div>
            
            <div class="mt-3 pt-3 border-t border-gray-700">
                <button onclick="saveStats()" class="w-full bg-blue-600 py-3 rounded-lg font-bold text-white shadow-lg uppercase tracking-wide hover:bg-blue-500 transition">SAVE STATS</button>
            </div>
        </div>
    </div>

    <!-- MODAL 2: PRIZE DISTRIBUTION -->
    <div id="prizeModal" class="fixed inset-0 bg-black/90 hidden items-center justify-center z-[90] p-4 backdrop-blur-sm">
        <div class="bg-gray-800 p-5 rounded-2xl w-full max-w-sm h-[70vh] flex flex-col relative shadow-2xl border border-green-500/30 animate-zoom">
            <div class="flex justify-between items-center mb-3 pb-2 border-b border-gray-700">
                <div><h3 class="font-bold text-lg text-green-400">Distribute Prizes</h3><p class="text-[10px] text-gray-400">Review & Send Money</p></div>
                <button onclick="document.getElementById('prizeModal').style.display='none'" class="text-gray-400 text-2xl hover:text-white">&times;</button>
            </div>
            <input type="hidden" id="prize_match_id"><input type="hidden" id="prize_is_solo">

            <div class="bg-green-900/20 p-2 rounded mb-2 text-center border border-green-500/20">
                <p class="text-[10px] text-green-300">Based on updated stats</p>
            </div>

            <div class="flex justify-between text-[9px] font-bold text-gray-500 uppercase px-2 mb-1">
                <span class="w-1/2">Winner</span><span class="w-1/4 text-center">Details</span><span class="w-1/4 text-center">Amount (à§³)</span>
            </div>
            <div id="prize_list" class="flex-1 overflow-y-auto pr-1 custom-scroll text-sm space-y-2">Calculating...</div>

            <div class="mt-3 pt-3 border-t border-gray-700">
                <button onclick="sendPrizes()" class="w-full bg-green-600 py-3 rounded-lg font-bold text-white shadow-lg uppercase tracking-wide hover:bg-green-500 transition">SEND MONEY</button>
            </div>
        </div>
    </div>

    <script>
        // Load Matches Logic
        async function loadMatches() {
            const list = document.getElementById('match_list');
            try {
                const res = await fetch('/api/admin', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ type:'get_admin_matches' }) });
                const matches = await res.json();
                list.innerHTML = "";
                
                if (matches.length > 0) {
                    list.innerHTML = matches.map(m => `
                        <div class="bg-gray-800 p-4 rounded-xl border border-gray-700 shadow-md mb-3">
                            <div class="flex justify-between mb-2">
                                <h4 class="font-bold text-white">#${m.id} ${m.title}</h4>
                                <span class="text-xs text-gray-400">${new Date(m.match_time).toLocaleString()}</span>
                            </div>
                            <div class="text-[10px] text-gray-400 mb-3 flex gap-3">
                                <span>TYPE: ${m.match_type}</span>
                                <span>PRIZE: ${m.prize_pool}</span>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="openStatsModal(${m.id}, '${m.match_type}')" class="bg-blue-600 text-white py-2 rounded text-xs font-bold border border-blue-500 hover:bg-blue-500 uppercase">1. Update Stats</button>
                                <button onclick="openPrizeModal(${m.id}, '${m.match_type}')" class="bg-green-600 text-white py-2 rounded text-xs font-bold border border-green-500 hover:bg-green-500 uppercase">2. Distribute Prize</button>
                            </div>
                        </div>`).join('');
                } else { list.innerHTML = `<p class="text-center text-gray-500">No matches found.</p>`; }
            } catch(e) { console.error(e); }
        }

        // --- 1. STATS UPDATE MODAL ---
        async function openStatsModal(id, type) {
            document.getElementById('resultModal').style.display = 'flex';
            document.getElementById('stat_match_id').value = id;
            const isSolo = (type === 'Solo');
            document.getElementById('stat_is_solo').value = isSolo ? '1' : '0';
            
            const con = document.getElementById('stat_list');
            con.innerHTML = '<p class="text-center text-gray-500 mt-5">Loading...</p>';

            try {
                const res = await fetch('/api/admin', { method:'POST', body:JSON.stringify({ type:'get_match_participants_for_result', match_id:id }) });
                const d = await res.json();
                
                if(d.data.length === 0) { con.innerHTML = '<p class="text-center text-gray-500">No players found.</p>'; return; }

                con.innerHTML = d.data.map(p => `
                    <div class="bg-gray-900 border border-gray-700 p-2 rounded flex items-center justify-between stat-row" data-name="${p.name}">
                        <div class="w-1/2 font-bold text-xs text-white truncate">${p.name}</div>
                        <input type="number" placeholder="#" value="${p.rank||''}" class="w-1/4 bg-black text-white text-xs p-1 text-center border border-gray-600 rounded mr-1 stat-rank">
                        <input type="number" placeholder="0" value="${p.kills||0}" class="w-1/4 bg-black text-white text-xs p-1 text-center border border-gray-600 rounded stat-kill">
                    </div>`).join('');
            } catch(e) { alert("Error loading"); }
        }

        async function saveStats() {
            const mid = document.getElementById('stat_match_id').value;
            const isSolo = document.getElementById('stat_is_solo').value === '1';
            let stats = [];
            
            document.querySelectorAll('.stat-row').forEach(row => {
                const name = row.getAttribute('data-name');
                const rank = row.querySelector('.stat-rank').value || 0;
                const kills = row.querySelector('.stat-kill').value || 0;
                stats.push({ name, rank, kills });
            });

            try {
                const res = await fetch('/api/admin', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ type:'update_match_stats', match_id:mid, stats:stats, is_solo:isSolo }) });
                if((await res.json()).success) { alert("Stats Saved!"); document.getElementById('resultModal').style.display='none'; }
                else alert("Failed");
            } catch(e) { alert("Network Error"); }
        }

        // --- 2. PRIZE DISTRIBUTION MODAL ---
        async function openPrizeModal(id, type) {
            document.getElementById('prizeModal').style.display = 'flex';
            document.getElementById('prize_match_id').value = id;
            const isSolo = (type === 'Solo');
            document.getElementById('prize_is_solo').value = isSolo ? '1' : '0';

            const con = document.getElementById('prize_list');
            con.innerHTML = '<p class="text-center text-gray-500 mt-5">Calculating...</p>';

            try {
                const res = await fetch('/api/admin', { method:'POST', body:JSON.stringify({ type:'get_prize_calcs', match_id:id }) });
                const d = await res.json();
                
                if(d.list.length === 0) { con.innerHTML = '<p class="text-center text-gray-500">No winners calculated.<br>Update stats first.</p>'; return; }

                con.innerHTML = d.list.map(w => `
                    <div class="bg-gray-900 border border-gray-700 p-2 rounded flex items-center justify-between prize-row" data-name="${w.name}">
                        <div class="w-1/2 font-bold text-xs text-white truncate">${w.name}</div>
                        <div class="w-1/4 text-[9px] text-gray-400 text-center">Rank:${w.rank} | K:${w.kills}</div>
                        <input type="number" value="${w.amount}" class="w-1/4 bg-black text-green-400 font-bold text-xs p-1 text-center border border-green-600 rounded prize-amount">
                    </div>`).join('');
            } catch(e) { alert("Error calculating"); }
        }

        async function sendPrizes() {
            if(!confirm("Send Money to Wallets?")) return;
            const mid = document.getElementById('prize_match_id').value;
            const isSolo = document.getElementById('prize_is_solo').value === '1';
            let prizes = [];

            document.querySelectorAll('.prize-row').forEach(row => {
                const name = row.getAttribute('data-name');
                const amount = row.querySelector('.prize-amount').value;
                if(amount > 0) prizes.push({ name, amount });
            });

            try {
                const res = await fetch('/api/admin', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ type:'distribute_prizes', match_id:mid, prizes:prizes, is_solo:isSolo }) });
                if((await res.json()).success) { alert("Money Sent Successfully!"); document.getElementById('prizeModal').style.display='none'; loadMatches(); }
                else alert("Failed");
            } catch(e) { alert("Network Error"); }
        }

        loadMatches();
    </script>
</body>
</html>
