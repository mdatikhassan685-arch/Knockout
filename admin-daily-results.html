<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Match Score & Payout</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        .custom-scroll::-webkit-scrollbar { width: 3px; background: #1f2937; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #eab308; }
    </style>
</head>
<body class="bg-gray-900 text-white pb-32">

    <header class="p-4 bg-gray-800 shadow-md flex items-center sticky top-0 z-50 border-b border-gray-700">
        <a href="javascript:history.back()" class="mr-4 text-gray-400 active:scale-90"><i class="fa-solid fa-arrow-left text-xl"></i></a>
        <div><h1 class="font-bold text-lg text-yellow-500">Update Match Result</h1><p class="text-[10px] text-gray-400">Step 1: Save Score | Step 2: Pay Winners</p></div>
    </header>

    <div class="p-4 max-w-lg mx-auto">
        <!-- 1. Score Entry Section -->
        <div class="mb-6">
            <h3 class="text-xs font-bold text-gray-500 uppercase mb-3 ml-1">Step 1: Enter Rank & Kills</h3>
            <div id="input_list" class="space-y-2">
                <p class="text-center text-gray-700 py-10 animate-pulse">Loading participants...</p>
            </div>
            <button onclick="saveScoresOnly()" id="score_btn" class="w-full mt-4 bg-blue-600 py-3 rounded-xl font-bold shadow-lg uppercase text-sm">Save Scores Only</button>
        </div>

        <hr class="border-gray-800 my-8">

        <!-- 2. Payout Section -->
        <div id="payout_section" class="hidden">
            <h3 class="text-xs font-bold text-green-500 uppercase mb-3 ml-1">Step 2: Review & Edit Prizes</h3>
            <div id="payout_summary" class="space-y-3 mb-6"></div>
            <button onclick="confirmPayout()" id="confirm_btn" class="w-full bg-green-600 py-4 rounded-xl font-black shadow-lg uppercase tracking-widest active:scale-95 transition">Distribute Money & Complete Match</button>
        </div>
    </div>

    <script>
        const mid = new URLSearchParams(window.location.search).get('match_id');
        let players = [], isSolo = true;

        async function loadData() {
            const res = await fetch('/api/admin', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ type:'get_match_participants_for_result', match_id:mid }) });
            const d = await res.json();
            players = d.data; isSolo = (d.type === 'Solo');
            
            document.getElementById('input_list').innerHTML = players.map(p => `
                <div class="bg-gray-800 p-4 rounded-xl border border-gray-700 flex justify-between items-center p-row" data-name="${p.name}">
                    <div class="w-1/3 pr-2">
                        <p class="font-bold text-sm truncate">${p.name}</p>
                        <p class="text-[9px] text-gray-500 uppercase">${isSolo?'Player':'Team Leader'}</p>
                    </div>
                    <div class="flex gap-2 w-2/3">
                        <input type="number" value="${p.rank || ''}" placeholder="Rank #" class="w-1/2 bg-gray-900 p-2 rounded border border-gray-600 text-center text-sm rank-val focus:border-yellow-500 outline-none">
                        <input type="number" value="${p.kills || ''}" placeholder="Kills" class="w-1/2 bg-gray-900 p-2 rounded border border-gray-600 text-center text-sm kill-val focus:border-red-500 outline-none">
                    </div>
                </div>`).join('');
        }

        // --- ৩. শুধু স্কোর সেভ করা ---
        async function saveScoresOnly() {
            const btn = document.getElementById('score_btn'); btn.disabled = true; btn.innerText = "Saving...";
            let stats = [];
            document.querySelectorAll('.p-row').forEach(row => {
                stats.push({ name: row.getAttribute('data-name'), rank: parseInt(row.querySelector('.rank-val').value) || 0, kills: parseInt(row.querySelector('.kill-val').value) || 0 });
            });

            try {
                const res = await fetch('/api/admin', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ type:'update_match_results_only', match_id:mid, stats, is_solo: isSolo }) });
                const d = await res.json();
                if(d.success) { 
                    alert("Scores Saved! Now review the prizes below."); 
                    loadPayoutPreview(); 
                }
            } catch(e) { alert("Error saving scores"); }
            btn.disabled = false; btn.innerText = "Save Scores Only";
        }

        // --- ৪. প্রাইজ রিভিউ এবং এডিট করার ব্যবস্থা ---
        async function loadPayoutPreview() {
            const res = await fetch('/api/admin', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ type:'get_prize_distribution_data', match_id:mid }) });
            const d = await res.json();
            
            const list = document.getElementById('payout_summary');
            document.getElementById('payout_section').classList.remove('hidden');

            list.innerHTML = d.data.map((p, i) => {
                // অটো ক্যালকুলেটেড টাকা
                const autoAmount = (parseFloat(p.kill_money) + parseFloat(p.rank_prize)).toFixed(2);
                
                return `
                <div class="bg-gray-800 p-4 rounded-xl border border-gray-700 payout-row" data-name="${p.name}">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <p class="font-bold text-white text-sm">${p.name}</p>
                            <p class="text-[9px] text-gray-500 uppercase">Rank: ${p.rank} | Kills: ${p.kills} (Auto: ৳${autoAmount})</p>
                        </div>
                        <span class="text-[10px] bg-black/40 px-2 py-1 rounded text-yellow-500 font-bold border border-yellow-500/20">WINNER</span>
                    </div>
                    <div class="relative">
                        <span class="absolute left-3 top-2.5 text-gray-500 text-sm font-bold">৳</span>
                        <input type="number" value="${autoAmount}" class="w-full bg-gray-900 p-2.5 pl-8 rounded-lg border border-green-500/30 text-green-400 font-black outline-none focus:border-green-500 final-prize-val">
                    </div>
                    <p class="text-[8px] text-gray-600 mt-1">* You can manually change the amount above</p>
                </div>`;
            }).join('');
            
            // নিচে স্ক্রল করবে যাতে এডমিন বুঝতে পারে পরের ধাপ এসেছে
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }

        // --- ৫. ফাইনাল টাকা পাঠানো ---
        async function confirmPayout() {
            let finalPrizes = [];
            document.querySelectorAll('.payout-row').forEach(row => {
                const amt = parseFloat(row.querySelector('.final-prize-val').value) || 0;
                if(amt > 0) {
                    finalPrizes.push({ name: row.getAttribute('data-name'), amount: amt });
                }
            });

            if(finalPrizes.length === 0) return alert("No prize amounts entered!");
            if(!confirm(`Send money to ${finalPrizes.length} winners? This cannot be undone.`)) return;

            const btn = document.getElementById('confirm_btn'); btn.disabled = true; btn.innerText = "Processing Payout...";

            try {
                const res = await fetch('/api/admin', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ type:'distribute_prizes_final', match_id:mid, prizes: finalPrizes, is_solo: isSolo }) });
                const d = await res.json();
                if(d.success) { 
                    alert("✅ Money Sent Successfully! Match is now COMPLETED."); 
                    window.location.href = '/admin-matches'; 
                } else { alert("Error: " + d.error); }
            } catch(e) { alert("Network Error"); }
            
            btn.disabled = false; btn.innerText = "Distribute Money & Complete Match";
        }

        loadData();
    </script>
</body>
</html>
