<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Match Score & Payout</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body class="bg-gray-900 text-white pb-32">

    <header class="p-4 bg-gray-800 shadow-md flex items-center sticky top-0 z-50 border-b border-gray-700">
        <a href="javascript:history.back()" class="mr-4 text-gray-400 active:scale-90"><i class="fa-solid fa-arrow-left text-xl"></i></a>
        <div><h1 class="font-bold text-lg text-green-500">Update Scores</h1><p class="text-[10px] text-gray-400">Calculate & Distribute Winnings</p></div>
    </header>

    <div class="p-4 max-w-lg mx-auto">
        <div id="input_list" class="space-y-3">
            <p class="text-center text-gray-500 animate-pulse py-10">Loading participants...</p>
        </div>
    </div>

    <!-- Review Modal -->
    <div id="payoutModal" class="fixed inset-0 bg-black/95 hidden items-center justify-center z-[100] p-4">
        <div class="bg-gray-800 p-6 rounded-2xl w-full max-w-md border border-gray-700 shadow-2xl flex flex-col">
            <h3 class="text-xl font-bold mb-4 text-yellow-500 border-b border-gray-700 pb-2">Review Final Prizes</h3>
            <div id="payout_summary" class="flex-1 overflow-y-auto space-y-2 mb-6 pr-2 max-h-[50vh]"></div>
            <div class="flex gap-3">
                <button onclick="document.getElementById('payoutModal').style.display='none'" class="flex-1 bg-gray-700 py-3 rounded-xl font-bold">Back</button>
                <button onclick="confirmPayout()" id="confirm_btn" class="flex-1 bg-green-600 py-3 rounded-xl font-bold">SEND MONEY NOW</button>
            </div>
        </div>
    </div>

    <div class="fixed bottom-0 left-0 right-0 p-4 bg-gray-800 border-t border-gray-700 z-40">
        <button onclick="reviewPrizes()" class="w-full bg-blue-600 py-4 rounded-xl font-bold shadow-lg uppercase tracking-widest active:scale-95 transition">Calculate & Review</button>
    </div>

    <script>
        const mid = new URLSearchParams(window.location.search).get('match_id');
        let players = [], isSolo = true;

        async function loadPlayers() {
            const res = await fetch('/api/admin', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ type:'get_match_participants_for_result', match_id:mid }) });
            const d = await res.json();
            players = d.data; isSolo = (d.type === 'Solo');
            
            document.getElementById('input_list').innerHTML = players.map(p => `
                <div class="bg-gray-800 p-4 rounded-xl border border-gray-700 flex justify-between items-center p-row" data-name="${p.name}">
                    <div class="w-1/3 pr-2"><p class="font-bold text-sm truncate">${p.name}</p><p class="text-[9px] text-gray-500 uppercase">${isSolo?'Player':'Team Leader'}</p></div>
                    <div class="flex gap-2 w-2/3">
                        <input type="number" placeholder="Rank #" class="w-1/2 bg-gray-900 p-2 rounded border border-gray-600 text-center text-sm rank-val">
                        <input type="number" placeholder="Kills" class="w-1/2 bg-gray-900 p-2 rounded border border-gray-600 text-center text-sm kill-val">
                    </div>
                </div>`).join('');
        }

        let finalPrizes = [];

        async function reviewPrizes() {
            let stats = [];
            document.querySelectorAll('.p-row').forEach(row => {
                stats.push({ name: row.getAttribute('data-name'), rank: parseInt(row.querySelector('.rank-val').value) || 0, kills: parseInt(row.querySelector('.kill-val').value) || 0 });
            });

            const res = await fetch('/api/admin', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ type:'get_prize_distribution_data', match_id:mid, stats }) });
            const d = await res.json();
            finalPrizes = d.data;

            document.getElementById('payout_summary').innerHTML = finalPrizes.map(p => `
                <div class="flex justify-between items-center bg-gray-900 p-3 rounded-lg border border-gray-700">
                    <div><p class="text-sm font-bold">${p.name}</p><p class="text-[9px] text-gray-500">R:${p.rank} | K:${p.kills}</p></div>
                    <p class="font-bold text-green-400">à§³${p.total.toFixed(2)}</p>
                </div>`).join('');
            document.getElementById('payoutModal').style.display = 'flex';
        }

        async function confirmPayout() {
            if(!confirm("Distribute Money and COMPLETE Match?")) return;
            const btn = document.getElementById('confirm_btn'); btn.disabled = true; btn.innerText = "Wait...";

            const res = await fetch('/api/admin', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ type:'distribute_prizes_final', match_id:mid, prizes: finalPrizes, is_solo: isSolo }) });
            const d = await res.json();
            if(d.success) { alert("Money Sent & Match Completed!"); window.location.href = '/admin-matches'; }
            else { alert("Error: " + d.error); btn.disabled = false; btn.innerText = "SEND MONEY NOW"; }
        }

        loadPlayers();
    </script>
</body>
</html>
