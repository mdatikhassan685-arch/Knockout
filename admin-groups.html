<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Groups</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', sans-serif; user-select: none; } 
        .custom-scroll::-webkit-scrollbar { width: 4px; background: #374151; } 
        .custom-scroll::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 4px; }
    </style>
</head>
<body class="bg-blue-900 text-white pb-32">

    <header class="p-4 bg-blue-800 shadow-md flex items-center sticky top-0 z-50 border-b border-blue-700">
        <a href="javascript:history.back()" class="mr-4 text-gray-200"><i class="fa-solid fa-arrow-left text-xl"></i></a>
        <div>
            <h1 class="font-bold text-lg text-white">Manage Groups</h1>
            <p class="text-[10px] text-blue-200">Bulk Assign & Remove</p>
        </div>
    </header>

    <div class="p-4 max-w-lg mx-auto">
        
        <!-- SEARCH BOX -->
        <div class="bg-white p-3 rounded-lg shadow-lg mb-6 text-gray-800">
            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Bulk Search Teams:</label>
            <div class="flex gap-2">
                <textarea id="search_query" rows="2" placeholder="e.g. TeamA, TeamB" class="w-full border p-2 rounded text-sm outline-none focus:border-blue-500"></textarea>
                <button onclick="filterTeams()" class="bg-blue-600 text-white px-4 py-2 rounded font-bold text-sm hover:bg-blue-700">Search</button>
            </div>
            <div class="mt-2 text-right">
                <button onclick="clearSearch()" class="text-red-500 text-xs font-bold underline hidden" id="clear_btn">Clear Search</button>
            </div>
        </div>

        <!-- UNASSIGNED TEAMS -->
        <div class="bg-white text-gray-800 rounded-lg shadow-lg p-4 mb-6 border-l-4 border-yellow-500">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-lg font-bold">Unassigned (<span id="unassigned_count">0</span>)</h2>
                <label class="text-xs flex items-center cursor-pointer select-none font-bold text-blue-600">
                    <input type="checkbox" onclick="toggleAll('unassigned', this)" class="mr-1"> Select All
                </label>
            </div>
            
            <div id="unassigned_list" class="space-y-2 mb-4 max-h-60 overflow-y-auto custom-scroll pr-1">
                <p class="text-center text-gray-400 text-xs italic py-4">Loading...</p>
            </div>
        </div>

        <!-- ASSIGNED GROUPS (Dynamic) -->
        <div id="groups_container" class="space-y-4">
            <!-- Groups will be loaded here -->
        </div>

    </div>

    <!-- FIXED BOTTOM ACTION BAR -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t-2 border-blue-600 p-3 shadow-[0_-5px_20px_rgba(0,0,0,0.3)] z-50 max-w-lg mx-auto">
        <div class="flex flex-col gap-2">
            
            <!-- Assign To Group -->
            <div class="flex gap-2">
                <select id="target_group_select" class="w-2/3 p-2 border-2 border-blue-300 rounded font-bold text-sm text-gray-800 outline-none">
                    <option value="">Select Group...</option>
                    <option value="A">Group A</option>
                    <option value="B">Group B</option>
                    <option value="C">Group C</option>
                    <option value="D">Group D</option>
                </select>
                <button onclick="assignGroup()" class="w-1/3 bg-blue-600 text-white font-bold py-2 rounded shadow text-sm hover:bg-blue-700 transition">Assign</button>
            </div>

            <!-- Remove From Group -->
            <button onclick="removeGroup()" class="w-full bg-red-100 text-red-600 font-bold py-2 rounded border border-red-200 text-sm hover:bg-red-200 transition">
                Remove Selected from Groups
            </button>
        </div>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const stageId = params.get('stage_id');
        let allTeams = [];

        async function loadTeams() {
            try {
                const res = await fetch('/api/official', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ type: 'get_stage_teams', stage_id: stageId })
                });
                allTeams = await res.json();
                renderTeams(allTeams);
            } catch(e) { console.error(e); }
        }

        function renderTeams(teams) {
            const unassignedList = document.getElementById('unassigned_list');
            const groupsContainer = document.getElementById('groups_container');
            
            // Separate teams
            const unassigned = teams.filter(t => !t.group_name || t.group_name === 'None');
            
            // Group logic
            const groups = {};
            ['A', 'B', 'C', 'D'].forEach(g => groups[g] = []);
            
            teams.forEach(t => {
                if (t.group_name && t.group_name !== 'None') {
                    if (!groups[t.group_name]) groups[t.group_name] = [];
                    groups[t.group_name].push(t);
                }
            });

            // Render Unassigned
            document.getElementById('unassigned_count').innerText = unassigned.length;
            if (unassigned.length > 0) {
                unassignedList.innerHTML = unassigned.map(t => `
                    <label class="flex items-center p-2 bg-gray-100 rounded border hover:bg-gray-200 cursor-pointer transition select-none">
                        <input type="checkbox" value="${t.id}" class="team-checkbox unassigned mr-3 accent-blue-600 w-4 h-4">
                        <span class="text-sm font-semibold">${t.team_name}</span>
                    </label>
                `).join('');
            } else {
                unassignedList.innerHTML = '<p class="text-center text-gray-400 text-xs italic py-2">No unassigned teams.</p>';
            }

            // Render Groups
            groupsContainer.innerHTML = Object.keys(groups).map(gName => {
                const gTeams = groups[gName];
                const teamHtml = gTeams.length > 0 ? gTeams.map(t => `
                    <label class="flex items-center p-2 bg-green-50 rounded border hover:bg-green-100 cursor-pointer transition select-none">
                        <input type="checkbox" value="${t.id}" class="team-checkbox grp_${gName} mr-3 accent-green-600 w-4 h-4">
                        <span class="text-sm font-medium">${t.team_name}</span>
                    </label>
                `).join('') : '<p class="text-center text-gray-400 text-xs italic">Empty Group</p>';

                return `
                <div class="bg-white text-gray-800 rounded-lg shadow p-4 border-l-4 border-green-500">
                    <div class="flex justify-between items-center mb-3 border-b pb-2">
                        <h3 class="font-bold">Group ${gName} <span class="text-xs text-gray-500 font-normal">(${gTeams.length})</span></h3>
                        <label class="text-xs flex items-center cursor-pointer select-none font-bold text-green-600">
                            <input type="checkbox" onclick="toggleAll('grp_${gName}', this)" class="mr-1"> Select All
                        </label>
                    </div>
                    <div class="space-y-2">${teamHtml}</div>
                </div>`;
            }).join('');
        }

        // --- FILTER ---
        function filterTeams() {
            const query = document.getElementById('search_query').value.toLowerCase();
            if (!query) return;
            
            document.getElementById('clear_btn').classList.remove('hidden');
            
            const keywords = query.split(',').map(s => s.trim()).filter(s => s);
            
            const filtered = allTeams.filter(t => {
                return keywords.some(k => t.team_name.toLowerCase().includes(k));
            });
            
            renderTeams(filtered);
            
            // Auto check filtered teams
            document.querySelectorAll('.team-checkbox').forEach(cb => cb.checked = true);
        }

        function clearSearch() {
            document.getElementById('search_query').value = '';
            document.getElementById('clear_btn').classList.add('hidden');
            renderTeams(allTeams);
        }

        // --- ACTIONS ---
        function toggleAll(className, source) {
            document.querySelectorAll('.' + className).forEach(cb => cb.checked = source.checked);
        }

        function getSelectedIds() {
            return Array.from(document.querySelectorAll('.team-checkbox:checked')).map(cb => cb.value);
        }

        async function assignGroup() {
            const ids = getSelectedIds();
            const group = document.getElementById('target_group_select').value;
            
            if (ids.length === 0) return alert("Select teams first!");
            if (!group) return alert("Select a group!");

            const btn = event.target;
            btn.innerText = "..."; btn.disabled = true;

            try {
                await fetch('/api/official', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ type: 'assign_group', team_ids: ids, target_group: group })
                });
                // alert("Assigned!"); // Optional
                loadTeams(); // Reload
            } catch(e) { alert("Error"); }
            
            btn.innerText = "Assign"; btn.disabled = false;
        }

        async function removeGroup() {
            const ids = getSelectedIds();
            if (ids.length === 0) return alert("Select teams first!");
            
            if(!confirm("Remove selected teams from their groups?")) return;

            const btn = event.target;
            btn.innerText = "..."; btn.disabled = true;

            try {
                await fetch('/api/official', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    // Removing group means setting group to 'None' or NULL
                    body: JSON.stringify({ type: 'assign_group', team_ids: ids, target_group: 'None' }) 
                });
                loadTeams();
            } catch(e) { alert("Error"); }
            
            btn.innerText = "Remove Selected from Groups"; btn.disabled = false;
        }

        loadTeams();
    </script>
</body>
</html>
