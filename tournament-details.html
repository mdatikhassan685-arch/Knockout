<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tournament Details</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>body { background-color: #0f172a; color: white; user-select: none; }</style>
</head>
<body class="pb-20">

    <header class="p-4 bg-gray-900 shadow flex items-center sticky top-0 z-50">
        <a href="/home" class="mr-4 text-gray-400"><i class="fa-solid fa-arrow-left text-xl"></i></a>
        <h1 class="text-lg font-bold truncate" id="t_title">Tournament Details</h1>
    </header>

    <!-- TABS -->
    <div class="flex border-b border-gray-700 bg-gray-800 text-sm font-bold text-gray-400 sticky top-14 z-40">
        <button onclick="tab('schedule')" id="btn_schedule" class="flex-1 py-3 text-blue-500 border-b-2 border-blue-500">Schedule</button>
        <button onclick="tab('standings')" id="btn_standings" class="flex-1 py-3 hover:text-white">Standings</button>
        <button onclick="tab('teams')" id="btn_teams" class="flex-1 py-3 hover:text-white">Teams</button>
    </div>

    <!-- CONTENT -->
    <div class="p-4 min-h-screen">
        
        <!-- SCHEDULE TAB -->
        <div id="tab_schedule">
            <h3 class="font-bold text-lg mb-4 text-blue-400">Match Schedule</h3>
            <div id="schedule_list" class="space-y-4">
                <p class="text-center text-gray-500 animate-pulse">Loading schedule...</p>
            </div>
        </div>

        <!-- POINTS TABLE TAB -->
        <div id="tab_standings" class="hidden">
            <h3 class="font-bold text-lg mb-4 text-yellow-400">Points Table</h3>
            <div class="overflow-x-auto bg-gray-800 rounded-lg shadow-lg border border-gray-700">
                <table class="w-full text-left text-xs whitespace-nowrap">
                    <thead class="bg-gray-700 text-gray-300 uppercase font-bold">
                        <tr>
                            <th class="px-3 py-3">Rank</th>
                            <th class="px-3 py-3">Team</th>
                            <th class="px-3 py-3 text-center">M</th>
                            <th class="px-3 py-3 text-center">W</th>
                            <th class="px-3 py-3 text-center">Kills</th>
                            <th class="px-3 py-3 text-right">Total</th>
                        </tr>
                    </thead>
                    <tbody id="points_list" class="text-gray-200">
                        <tr><td colspan="6" class="p-4 text-center">No points updated yet.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- TEAMS TAB -->
        <div id="tab_teams" class="hidden">
             <h3 class="font-bold text-lg mb-4 text-green-400">Participating Teams</h3>
             <div id="teams_list" class="grid grid-cols-2 gap-3">
                 <!-- JS load -->
             </div>
        </div>

    </div>

    <!-- Join Button (Sticky) -->
    <div class="fixed bottom-0 w-full bg-gray-900 border-t border-gray-800 p-3 z-50">
        <button onclick="window.location.href='/matches'" class="w-full bg-blue-600 py-3 rounded-xl font-bold shadow-lg text-sm uppercase tracking-widest hover:bg-blue-700">Go to Join Page</button>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const tId = urlParams.get('id'); // Get ID from URL
        document.getElementById('t_title').innerText = urlParams.get('name') || "Official Tournament";

        // Tab Switcher
        function tab(name) {
            ['schedule', 'standings', 'teams'].forEach(t => {
                document.getElementById('tab_'+t).classList.add('hidden');
                document.getElementById('btn_'+t).className = "flex-1 py-3 text-gray-400 hover:text-white";
            });
            document.getElementById('tab_'+name).classList.remove('hidden');
            document.getElementById('btn_'+name).className = "flex-1 py-3 text-blue-500 border-b-2 border-blue-500 font-bold";
        }

        async function loadData() {
            if(!tId) return;

            // 1. Load Points
            try {
                const resP = await fetch('/api/user', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ type: 'get_tournament_points', tournament_id: tId })
                });
                const points = await resP.json();
                const pList = document.getElementById('points_list');
                
                if(points.length > 0) {
                    pList.innerHTML = points.map((p, i) => `
                        <tr class="border-b border-gray-700 hover:bg-gray-700/50">
                            <td class="px-3 py-3 font-bold ${i<3 ? 'text-yellow-400':''}">${i+1}</td>
                            <td class="px-3 py-3 font-semibold">${p.team_name}</td>
                            <td class="px-3 py-3 text-center">${p.matches_played}</td>
                            <td class="px-3 py-3 text-center text-green-400 font-bold">${p.booyahs}</td>
                            <td class="px-3 py-3 text-center">${p.kill_points}</td>
                            <td class="px-3 py-3 text-right font-black text-yellow-400 text-sm">${p.total_points}</td>
                        </tr>
                    `).join('');
                }
            } catch(e){}

            // 2. Load Manager Data (Schedule & Teams) for Users
            // Note: We are using admin API for structure data, you can move this logic to user API for security later.
            try {
                const resM = await fetch('/api/admin', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ type: 'get_manager_data', tournament_id: tId })
                });
                const data = await resM.json();

                // Render Schedule
                const sList = document.getElementById('schedule_list');
                if(data.schedules.length > 0) {
                    sList.innerHTML = data.schedules.map(s => `
                        <div class="bg-gray-800 p-4 rounded-xl border-l-4 border-blue-500 shadow-md">
                            <p class="text-xs text-blue-400 font-bold uppercase mb-1">${s.day_title}</p>
                            <h3 class="font-bold text-white text-lg">${s.match_title}</h3>
                            <div class="flex justify-between items-center mt-2 text-sm text-gray-400">
                                <span><i class="fa-solid fa-map"></i> ${s.map_name}</span>
                                <span class="text-white bg-gray-700 px-2 py-1 rounded text-xs">${new Date(s.start_time).toLocaleString()}</span>
                            </div>
                        </div>
                    `).join('');
                } else { sList.innerHTML = '<p class="text-center text-gray-500">Schedule to be announced.</p>'; }

                // Render Teams
                const tList = document.getElementById('teams_list');
                if(data.teams.length > 0) {
                    tList.innerHTML = data.teams.map(t => `
                        <div class="bg-gray-800 p-3 rounded-lg border border-gray-700 text-center">
                            <h4 class="font-bold text-sm truncate text-white">${t.team_name || t.in_game_name}</h4>
                            ${t.group_name ? `<span class="bg-purple-600/20 text-purple-400 text-[10px] px-2 py-0.5 rounded uppercase mt-1 inline-block font-bold">${t.group_name}</span>` : ''}
                        </div>
                    `).join('');
                } else { tList.innerHTML = '<p class="col-span-2 text-center text-gray-500">Registration ongoing...</p>'; }

            } catch(e){}
        }

        loadData();
    </script>
</body>
  </html>
