<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tournament Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { user-select: none; } 
        .custom-scroll::-webkit-scrollbar { width: 4px; background: #374151; } 
        .custom-scroll::-webkit-scrollbar-thumb { background: #eab308; border-radius: 4px; }
    </style>
</head>
<body class="bg-gray-900 text-white pb-32">

    <!-- Header -->
    <header class="p-4 bg-gray-800 shadow-md flex items-center sticky top-0 z-50 border-b border-gray-700">
        <a href="/admin-categories?mode=select&type=official" class="mr-4 text-gray-400 active:scale-90"><i class="fa-solid fa-arrow-left text-xl"></i></a>
        <div>
            <h1 class="font-bold text-lg text-yellow-500">Manage Tournament</h1>
            <p class="text-[10px] text-gray-400" id="tour_title">Loading...</p>
        </div>
    </header>

    <div class="p-4 max-w-lg mx-auto">
        
        <!-- Info Card -->
        <div class="bg-gray-800 p-5 rounded-xl border border-gray-700 shadow-lg mb-6 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-20 h-20 bg-yellow-500/10 rounded-full -mr-10 -mt-10 blur-xl"></div>
            <h2 class="text-xl font-bold text-white mb-1" id="tour_name_display">...</h2>
            <p class="text-xs text-gray-400 font-mono bg-gray-900 px-2 py-1 rounded inline-block border border-gray-700">ID: <span id="tour_id_display">...</span></p>
        </div>

        <!-- Tools -->
        <div class="grid grid-cols-2 gap-3 mb-6">
            <button onclick="goToPage('groups')" class="bg-blue-600/20 border border-blue-600/50 text-blue-400 py-4 rounded-xl font-bold shadow-lg transition flex flex-col items-center gap-1 active:scale-95">
                <i class="fa-solid fa-users-rectangle text-2xl mb-1"></i><span class="text-xs uppercase">Groups</span>
            </button>
            <button onclick="goToPage('schedule')" class="bg-purple-600/20 border border-purple-600/50 text-purple-400 py-4 rounded-xl font-bold shadow-lg transition flex flex-col items-center gap-1 active:scale-95">
                <i class="fa-solid fa-calendar-days text-2xl mb-1"></i><span class="text-xs uppercase">Schedule</span>
            </button>
        </div>

        <div class="space-y-3 mb-8">
            <button onclick="goToPage('schedule')" class="w-full bg-gray-800 p-4 rounded-xl border border-gray-700 flex items-center justify-between active:scale-95 transition hover:border-yellow-500">
                <div class="flex items-center gap-3"><div class="bg-indigo-500/20 p-2 rounded-lg text-indigo-400"><i class="fa-solid fa-shuffle"></i></div><span class="text-sm font-bold">Manage Rounds</span></div>
                <i class="fa-solid fa-chevron-right text-gray-600 text-xs"></i>
            </button>
            <button onclick="goToPage('points')" class="w-full bg-gray-800 p-4 rounded-xl border border-gray-700 flex items-center justify-between active:scale-95 transition hover:border-green-500">
                <div class="flex items-center gap-3"><div class="bg-green-500/20 p-2 rounded-lg text-green-400"><i class="fa-solid fa-chart-simple"></i></div><span class="text-sm font-bold">Update Results</span></div>
                <i class="fa-solid fa-chevron-right text-gray-600 text-xs"></i>
            </button>
        </div>

        <!-- TEAMS LIST HEADER -->
        <div class="flex justify-between items-center mb-3 px-1">
            <h3 class="text-gray-400 font-bold uppercase text-xs tracking-wider border-l-2 border-blue-500 pl-2">Teams (<span id="team_count">0</span>)</h3>
            <div class="flex items-center gap-2">
                <label class="text-[10px] text-blue-400 font-bold cursor-pointer select-none">
                    <input type="checkbox" onclick="toggleAll(this)" class="mr-1 accent-blue-500"> Select All
                </label>
                <button onclick="addBotTeams()" class="bg-gray-700 text-gray-300 px-2 py-1 rounded text-[10px] font-bold border border-gray-600 hover:text-white transition">
                    <i class="fa-solid fa-robot"></i> +Bots
                </button>
            </div>
        </div>

        <!-- LIST CONTAINER -->
        <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden shadow-lg">
            <div class="p-3 border-b border-gray-700">
                <input type="text" id="search_team" onkeyup="filterTeams()" placeholder="Search team..." class="w-full bg-gray-900 p-2 rounded-lg border border-gray-600 outline-none text-sm text-white focus:border-blue-500">
            </div>
            <div id="team_list_full" class="max-h-[350px] overflow-y-auto custom-scroll p-2 space-y-1">
                <p class="text-center text-xs text-gray-500 py-4">Loading teams...</p>
            </div>
        </div>

    </div>

    <!-- TEAM DETAILS MODAL -->
    <div id="teamModal" class="fixed inset-0 bg-black/90 hidden items-center justify-center z-[60] p-4 backdrop-blur-sm">
        <div class="bg-gray-800 p-6 rounded-xl w-full max-w-sm border border-gray-600 shadow-2xl relative">
            <button onclick="document.getElementById('teamModal').style.display='none'" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i class="fa-solid fa-times text-xl"></i></button>
            <h3 class="font-bold text-lg text-white mb-1" id="modal_team_name">Team Name</h3>
            <p class="text-xs text-blue-400 font-mono mb-4">ID: <span id="modal_team_id">...</span></p>
            <div class="bg-gray-900 p-4 rounded-lg border border-gray-700">
                <p class="text-[10px] text-gray-500 uppercase font-bold mb-2 border-b border-gray-700 pb-1">Team Members</p>
                <div id="modal_members" class="space-y-2 text-sm text-gray-300"></div>
            </div>
        </div>
    </div>

    <!-- FIXED BOTTOM BAR (Bulk Action) -->
    <div id="bulk_action_bar" class="fixed bottom-0 left-0 right-0 bg-gray-800 border-t border-gray-700 p-3 z-50 hidden shadow-[0_-5px_20px_rgba(0,0,0,0.5)]">
        <div class="max-w-lg mx-auto flex justify-between items-center">
            <span class="text-xs text-gray-400 font-bold"><span id="selected_count">0</span> Selected</span>
            <button onclick="bulkKick()" class="bg-red-600 text-white px-4 py-2 rounded-lg text-xs font-bold shadow-lg hover:bg-red-700 transition flex items-center gap-2">
                <i class="fa-solid fa-trash"></i> Kick Selected
            </button>
        </div>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const tourId = params.get('tour_id');
        const tourTitle = params.get('title');
        let allTeams = [];

        if(tourTitle) {
            document.getElementById('tour_title').innerText = decodeURIComponent(tourTitle);
            document.getElementById('tour_name_display').innerText = decodeURIComponent(tourTitle);
        }
        document.getElementById('tour_id_display').innerText = tourId;

        function goToPage(page) {
            if(!tourId) return alert("Tournament ID missing");
            if (page === 'schedule') window.location.href = `/admin-stages?tour_id=${tourId}`;
            else if (page === 'groups') window.location.href = `/admin-groups?tour_id=${tourId}`;
            else if (page === 'points') window.location.href = `/admin-points?tour_id=${tourId}`;
        }

        async function loadTeams() {
            try {
                const res = await fetch('/api/official', { 
                    method: 'POST', 
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ type: 'get_official_standings', tournament_id: tourId }) 
                });
                const data = await res.json();
                allTeams = data;
                document.getElementById('team_count').innerText = data.length;
                renderList(data);
            } catch(e) { console.error(e); }
        }

        function renderList(teams) {
            const list = document.getElementById('team_list_full');
            if(teams.length > 0) {
                list.innerHTML = teams.map((t, i) => `
                    <div class="flex justify-between items-center bg-gray-700/30 p-3 rounded-lg hover:bg-gray-700 transition border border-transparent hover:border-gray-600 mb-1 group cursor-pointer" onclick="toggleSelect(this, ${t.id})">
                        <div class="flex items-center gap-3">
                            <input type="checkbox" class="team-checkbox w-4 h-4 rounded bg-gray-900 border-gray-600 accent-blue-600 pointer-events-none" value="${t.id}">
                            <span class="text-xs font-bold text-gray-500 w-5">#${i+1}</span>
                            <div>
                                <p class="text-sm font-bold text-gray-200">${t.team_name}</p>
                                <p class="text-[9px] text-blue-400 font-mono">ID: ${t.id}</p>
                            </div>
                        </div>
                        <button onclick='event.stopPropagation(); openTeamDetails(${JSON.stringify(t).replace(/'/g, "&#39;")})' class="text-gray-400 hover:text-white p-2"><i class="fa-solid fa-circle-info"></i></button>
                    </div>
                `).join('');
            } else {
                list.innerHTML = '<p class="text-center text-xs text-gray-500 py-4">No teams found.</p>';
            }
            updateBulkBar();
        }

        function filterTeams() {
            const query = document.getElementById('search_team').value.toLowerCase();
            const filtered = allTeams.filter(t => t.team_name.toLowerCase().includes(query));
            renderList(filtered);
        }

        // --- SELECTION LOGIC ---
        function toggleSelect(div, id) {
            const cb = div.querySelector('.team-checkbox');
            cb.checked = !cb.checked;
            
            if(cb.checked) {
                div.classList.add('bg-blue-900/20', 'border-blue-500/30');
            } else {
                div.classList.remove('bg-blue-900/20', 'border-blue-500/30');
            }
            updateBulkBar();
        }

        function toggleAll(source) {
            document.querySelectorAll('.team-checkbox').forEach(cb => {
                cb.checked = source.checked;
                const div = cb.closest('div.group'); // Ensure correct parent
                if(source.checked) div.classList.add('bg-blue-900/20', 'border-blue-500/30');
                else div.classList.remove('bg-blue-900/20', 'border-blue-500/30');
            });
            updateBulkBar();
        }

        function updateBulkBar() {
            const count = document.querySelectorAll('.team-checkbox:checked').length;
            document.getElementById('selected_count').innerText = count;
            const bar = document.getElementById('bulk_action_bar');
            if(count > 0) bar.classList.remove('hidden'); else bar.classList.add('hidden');
        }

        // --- BULK KICK ---
        async function bulkKick() {
            const ids = Array.from(document.querySelectorAll('.team-checkbox:checked')).map(cb => cb.value);
            if(ids.length === 0) return;

            if(!confirm(`⚠️ Kick ${ids.length} selected teams?\n- They will be refunded.\n- This cannot be undone.`)) return;

            const btn = event.target;
            btn.innerText = "Processing..."; btn.disabled = true;

            try {
                const res = await fetch('/api/official', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ type: 'bulk_kick_teams', team_ids: ids })
                });
                const d = await res.json();
                if(d.success) { alert(d.message); loadTeams(); } else { alert("Error: " + d.error); }
            } catch(e) { alert("Network Error"); }
            
            btn.innerHTML = '<i class="fa-solid fa-trash"></i> Kick Selected'; btn.disabled = false;
        }

        function openTeamDetails(t) {
            document.getElementById('modal_team_name').innerText = t.team_name;
            document.getElementById('modal_team_id').innerText = t.id;
            const members = t.team_members ? t.team_members.split(',') : ['No info'];
            document.getElementById('modal_members').innerHTML = members.map(m => `<div class="flex items-center gap-2"><i class="fa-solid fa-user text-gray-600 text-xs"></i><span>${m.trim()}</span></div>`).join('');
            document.getElementById('teamModal').style.display = 'flex';
        }

        async function addBotTeams() {
            const input = prompt("How many bots?", "10");
            if(input === null) return;
            const count = parseInt(input);
            if(isNaN(count) || count <= 0) return alert("Invalid number");

            try {
                await fetch('/api/official', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ type: 'add_test_teams', tournament_id: tourId, count: count }) });
                loadTeams();
            } catch(e) { alert("Error"); }
        }

        loadTeams();
    </script>
</body>
</html>
