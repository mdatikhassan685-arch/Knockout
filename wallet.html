<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wallet</title>
    <style>
        body { font-family: sans-serif; background: #0f3460; color: white; margin: 0; padding: 10px; }
        .card { background: #16213e; padding: 20px; border-radius: 10px; text-align: center; margin-bottom: 20px; }
        .balance-text { font-size: 30px; color: #4caf50; font-weight: bold; margin: 10px 0; }
        
        .form-box { background: #1a1a2e; padding: 15px; border-radius: 10px; border: 1px solid #e94560; }
        .admin-num { background: #e94560; padding: 10px; border-radius: 5px; font-weight: bold; font-size: 18px; margin-bottom: 10px; display: block; }
        
        input, select { width: 95%; padding: 12px; margin: 8px 0; border-radius: 5px; border: none; background: #0f3460; color: white; }
        button { width: 100%; padding: 12px; background: #4caf50; color: white; border: none; border-radius: 5px; font-weight: bold; margin-top: 10px; cursor: pointer; }
        
        .history-item { background: #16213e; padding: 10px; margin-top: 5px; border-radius: 5px; display: flex; justify-content: space-between; }
        .badge { padding: 3px 8px; border-radius: 4px; font-size: 12px; }
        .pending { background: orange; color: black; }
        .approved { background: green; color: white; }
        
        .nav-btn { background: none; border: 1px solid white; margin-bottom: 10px; width: auto; padding: 5px 15px; }
    </style>
</head>
<body>

    <button onclick="window.location.href='/home'" class="nav-btn">⬅ Back</button>

    <!-- Balance Card -->
    <div class="card">
        <h3 data-key="wallet_title">আমার ওয়ালেট</h3>
        <div class="balance-text">৳ <span id="bal">0</span></div>
    </div>

    <!-- Deposit Form -->
    <div class="form-box">
        <h3 data-key="add_money">টাকা জমা দিন</h3>
        
        <p data-key="bkash_inst" style="font-size: 12px; color: #ccc;">Send Money করুন</p>
        <span class="admin-num">017XXXXXXXX</span> <!-- আপনার বিকাশ নাম্বার এখানে দেবেন -->

        <select id="method">
            <option value="bkash">bKash</option>
            <option value="nagad">Nagad</option>
            <option value="rocket">Rocket</option>
        </select>

        <input type="number" id="amount" data-key="amount_ph" placeholder="টাকার পরিমাণ">
        <input type="number" id="phone" data-key="send_num_ph" placeholder="প্রেরকের নাম্বার">
        <input type="text" id="trx" data-key="trx_ph" placeholder="TrxID">

        <button onclick="deposit()" data-key="deposit_btn">জমা নিশ্চিত করুন</button>
        <p id="msg" style="text-align: center; margin-top: 10px; font-size: 14px;"></p>
    </div>

    <!-- Transaction History -->
    <h3 data-key="history" style="margin-top: 20px;">লেনদেন</h3>
    <div id="history-list">
        <p style="text-align: center; color: #ccc;">Loading...</p>
    </div>

    <script src="lang.js"></script>
    <script>
        const user = JSON.parse(localStorage.getItem('user'));
        if(!user) window.location.href = '/';

        // 1. Load Data on Start
        async function loadWallet() {
            try {
                const res = await fetch('/api/user', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ type: 'get_wallet', userId: user.id })
                });
                const data = await res.json();
                
                document.getElementById('bal').innerText = data.balance;
                
                // Show History
                const list = document.getElementById('history-list');
                list.innerHTML = '';
                data.history.forEach(item => {
                    const statusClass = item.description.includes('Pending') ? 'pending' : 'approved';
                    list.innerHTML += `
                        <div class="history-item">
                            <span>${item.description}</span>
                            <span class="badge ${statusClass}">৳ ${item.amount}</span>
                        </div>
                    `;
                });

            } catch(e) { console.log(e); }
        }

        // 2. Deposit Function
        async function deposit() {
            const amount = document.getElementById('amount').value;
            const number = document.getElementById('phone').value;
            const trx = document.getElementById('trx').value;
            const method = document.getElementById('method').value;
            const msg = document.getElementById('msg');

            // Language check
            const lang = localStorage.getItem('appLang') || 'bn';
            const texts = lang==='bn' ? 
                {wait: 'অপেক্ষা করুন...', done: 'রিকুয়েস্ট সফল!'} : 
                {wait: 'Sending...', done: 'Request Sent!'};

            msg.style.color = "yellow";
            msg.innerText = texts.wait;

            try {
                const res = await fetch('/api/user', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        type: 'deposit', 
                        userId: user.id, 
                        amount, method, number, trxId: trx 
                    })
                });

                if(res.ok) {
                    msg.style.color = "green";
                    msg.innerText = texts.done;
                    loadWallet(); // Reload balance/history
                    // Clear inputs
                    document.getElementById('trx').value = '';
                } else {
                    msg.style.color = "red";
                    msg.innerText = "Error!";
                }
            } catch(e) { msg.innerText = "Server Error"; }
        }

        loadWallet(); // Run initially
    </script>
</body>
</html>
